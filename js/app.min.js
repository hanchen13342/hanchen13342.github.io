//v3.2 2020-04-17
function _webpushrExecuteHooks(e=""){q.forEach(function(t){t[0]==e?window.webpushr.apply(this,t):e||"debug"==t[0]||"init"==t[0]||window.webpushr.apply(this,t)})}function _webpushrSetCookie(e,t,o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3);var r="expires="+i.toUTCString();document.cookie=e+"="+t+";"+r+";path=/"}function _webpushrGetCookie(e){for(var t=e+"=",o=decodeURIComponent(document.cookie),i=o.split(";"),r=0;r<i.length;r++){for(var s=i[r];" "==s.charAt(0);)s=s.substring(1);if(0==s.indexOf(t))return s.substring(t.length,s.length)}return""}function _webpushrBrowserSupport(){if(navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform))return!1;if(localStorage.getItem("_webpushrPromptAction")){let e=JSON.parse(localStorage.getItem("_webpushrPromptAction")),t=new Date;if("Dismiss"==e.action&&e.expiry>t.getTime())return!1}return"safari"in window&&"pushNotification"in window.safari?"safari":-1!=window.location.href.indexOf("http://")?"http":"serviceWorker"in navigator?"PushManager"in window?"showNotification"in ServiceWorkerRegistration.prototype?"denied"===Notification.permission?(console.warn("WEBPUSHR: Notifications are denied by the user"),_webpushrGetPrompt("bell").then(e=>{_webpushrShowSubscriptionBell(e,"denied")}),!1):(_wp_debug&&console.log("WEBPUSHR: Browser supports web push notifications"),!0):(console.warn("WEBPUSHR: Notifications are not supported by this browser"),!1):(console.warn("WEBPUSHR: Push notifications are not supported by this browser"),!1):(console.warn("WEBPUSHR: Service workers are not supported by this browser"),!1)}function _wp_registerServiceWorker(){navigator.serviceWorker.register(_wp_sw_path,{scope:_sw_scope}).then(function(e){_wp_debug&&console.log("Service worker has been registered successfully!"),_webpushrCheckPermission()},e=>{console.error("[SW] Service worker registration failed",e),console.warn("Cannot access service worker file. Please confirm you have service worker file at  "+_wp_sw_path)})}function _webpushrCheckPermission(){if(-1!=window.location.href.indexOf("http://"))return _webpushrGetCookie("_webpushrSubscriberID")?(_wp_endpoint=_webpushrGetCookie("_webpushrSubscriberID"),fetch("https://webpushrbot.fuckcloudnative.io/logs/visit",{body:JSON.stringify({sub_id:_wp_endpoint,site_id:applicationServerKey,url:window.location.href}),method:"POST"}),_webpushrExecuteHooks(),void("undefined"!=typeof _webpushrScriptReady&&"function"==typeof _webpushrScriptReady&&_webpushrScriptReady())):void _webpushrGetPrompt("get_info").then(e=>{_webpushrGetPromptDisplayTime(e)});"default"==Notification.permission?_webpushrGetPrompt("get_info").then(e=>{_webpushrGetPromptDisplayTime(e)}):"granted"==Notification.permission&&(_webpushrGetPrompt("bell").then(e=>{_wp_debug&&console.log("User has previously granted push permission"),1==e.subscriptionbell_show&&_webpushrShowSubscriptionBell(e,"granted")}),_wpCheckSubscription())}async function _webpushrGetPrompt(e){const t=await fetch("https://webpushrbot.fuckcloudnative.io/prompt/"+e,{body:JSON.stringify({site_id:applicationServerKey,browser:user_browser}),method:"POST"});return _wp_prompt_info=await t.json(),_wp_prompt_info}function _webpushrGetPromptDisplayTime(e){"Immediately"==e.show_prompt?(_wp_debug&&console.log("Show prompt immediately"),_webpushrShowPrompt(e)):"Visits"==e.show_prompt?(_wp_debug&&console.log("Show prompt after x page views",_webpushrGetCookie("_webpushrPageViews"),+e.page_views),_webpushrGetCookie("_webpushrPageViews")>=+e.page_views?_webpushrShowPrompt(e):_webpushrSetCookie("_webpushrPageViews",+_webpushrGetCookie("_webpushrPageViews")+1,90)):"Time"==e.show_prompt&&(_wp_debug&&console.log("Show prompt after x seconds"),setTimeout(function(){_webpushrShowPrompt(e)},1e3*e.time_delay))}function _webpushrShowPrompt(e){1!=e.prompt_type||_wp_is_safari?_webpushrShowCustomPrompt(e):(_wp_debug&&console.log("Show native prompt"),_webpushrRequestPermission())}function _webpushrShowCustomPrompt(e){_wp_debug&&console.log("Show custom prompt"),_webpushrGetCookie("_webpushrSubscriberID")||(prompt_wrapper=document.createElement("div"),prompt_wrapper.setAttribute("id","webpushr-prompt-wrapper"),prompt_wrapper.innerHTML=e.code,document.body.appendChild(prompt_wrapper))}function _webpushrShowSubscriptionBell(e,t){prompt_wrapper=document.createElement("div"),prompt_wrapper.setAttribute("id","webpushr-prompt-wrapper"),"denied"===t?prompt_wrapper.setAttribute("class","webpushr-subscribed webpushr-notification-denied"):"granted"===t&&("off"==localStorage.getItem("_webpushrBellNotification")?prompt_wrapper.setAttribute("class","webpushr-subscribed webpushr-notification-off"):prompt_wrapper.setAttribute("class","webpushr-subscribed webpushr-notification-on")),prompt_wrapper.innerHTML=e.code,document.body.appendChild(prompt_wrapper),"denied"==t&&_webpushrPermissionResetInstructions()}function _webpushrPermissionResetInstructions(){denied_image_ele=document.getElementById("webpushrDeniedImg"),denied_image_ele&&(document.getElementById("webpushr-prompt-wrapper").className="webpushr-subscribed webpushr-notification-denied",navigator.userAgent.match(/Android/i)?denied_image_ele.src="https://webpushrapp.fuckcloudnative.io/assets/images/mobile.gif":"safari"in window?denied_image_ele.src="https://webpushrapp.fuckcloudnative.io/assets/images/safari-reset.gif":denied_image_ele.src="https://webpushrapp.fuckcloudnative.io/assets/images/allow_notifications.001-min.png")}function _webpushrPromptAction(e){if(_wp_debug&&console.log("Prompt action : "+e),2==_wp_prompt_info.display_position&&(document.getElementById("webpushr-prompt-wrapper").style.display="none"),"Dismiss"==e){let t=new Date;expiry=t.getTime()+24*_wp_prompt_info.re_show_prompt*60*60*1e3,localStorage.setItem("_webpushrPromptAction",JSON.stringify({action:e,expiry:expiry}))}if("Approve"==e)if(_wp_is_safari){_wp_debug&&console.log("Show safari prompt");var t=window.safari.pushNotification.permission(_wp_apple_push_id);checkRemotePermission(t)}else _wp_prompt_info.domain_label?window.open(_wp_prompt_info.domain_label+"/subscribe","wpushr-subscribe-dialog","width=626, height=436, resizable=0, scrollbars=0, status=0, titlebar=0, left="+(screen.width-626)/2+", top="+(screen.height-436)/2):_webpushrRequestPermission()}function _webpushrToggleEditNotificationPopup(){document.getElementById("webpushr-prompt-wrapper").classList.remove("webpushr-ackn","webpushr-server-success","webpushr-server-error"),document.getElementsByTagName("promptPopup")[0].classList.toggle("promptPopup-show"),document.getElementsByTagName("prompticon3")[0].classList.toggle("promptBellLarge")}function _webpushrTrunNotification(e,t){t.className+=" webpushrBtnWaiting",fetch("https://webpushrbot.fuckcloudnative.io/subscribe/status/"+e,{body:JSON.stringify({site_id:applicationServerKey,endpoint:_wp_endpoint}),method:"POST"},1e3).then(e=>e.json()).then(function(e){if("success"!=e.response)throw"failed";localStorage.setItem("_webpushrBellNotification",e.status),document.getElementById("webpushr-prompt-wrapper").className="webpushr-ackn webpushr-server-success webpushr-subscribed webpushr-notification-"+e.status,document.getElementsByClassName("webpushrBtnWaiting")[0].classList.remove("webpushrBtnWaiting"),setTimeout(_webpushrToggleEditNotificationPopup,500)}).catch(e=>{document.getElementById("webpushr-prompt-wrapper").className="webpushr-ackn webpushr-subscribed webpushr-server-error"})}function _wpCheckSubscription(){navigator.serviceWorker.ready.then(e=>e.pushManager.getSubscription()).then(e=>(_wp_debug&&console.log("Check subscription"),e?(_wp_debug&&console.log("User has previously granted push permission"),_webpushrSubscribeNow(e),_webpushrLastVisit=localStorage.getItem("_webpushrLastVisit"),(!_webpushrLastVisit||new Date(_webpushrLastVisit)<new Date(today))&&(localStorage.setItem("_webpushrLastVisit",today),_wp_debug&&console.log("Send last visit update request"),_webpushrLastVisit&&new Date(_webpushrLastVisit)<new Date(today))?_webpushrSendSubscriptionToServer(e,"PUT"):(_webpushrOldEndPoint=localStorage.getItem("_webpushrEndPoint"),_webpushrOldEndPoint||(localStorage.setItem("_webpushrEndPoint",e.endpoint),_webpushrOldEndPoint=localStorage.getItem("_webpushrEndPoint"),localStorage.setItem("_webpushrLastVisit",today)),_webpushrOldEndPoint!=e.endpoint?(_wp_debug&&console.log("existing user, endpoint change detected,  update subscription object and last visit in database & update new endpoint in local storage"),e.old_endpoint=_webpushrOldEndPoint,localStorage.setItem("_webpushrEndPoint",e.endpoint),_webpushrSendSubscriptionToServer(e,"PUT","update")):void 0)):(_wp_debug&&console.log("No subscription found, ask for permission"),void _webpushrRequestPermission()))).catch(e=>{console.log(e)})}function _webpushrRequestPermission(){Notification.requestPermission().then(e=>{switch(e){case"default":console.log("Permission unknown");break;case"denied":console.log("Permission denied"),"function"==typeof webpushrPermissionAction&&webpushrPermissionAction("denied"),_webpushrPermissionResetInstructions(),_webpushrSendSubscriptionToServer("","DELETE");break;case"granted":"function"==typeof webpushrPermissionAction&&webpushrPermissionAction("granted"),localStorage.removeItem("_webpushrBellNotification"),_webpushrSubscribeNow(),webpushrPromptWrapper=document.getElementById("webpushr-prompt-wrapper"),"undefined"!=typeof webpushrPromptWrapper&&(webpushrPromptWrapper.className="webpushr-subscribed webpushr-notification-on")}})}function _webpushrSubscribeNow(e=null){navigator.serviceWorker.ready.then(function(t){t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:_wp_urlBase64ToUint8Array(applicationServerKey)}).then(t=>{if(_wp_endpoint=end_point=t.endpoint,null==e)return _wp_debug&&console.log("New subscriber, store in localstorage and database"),localStorage.setItem("_webpushrEndPoint",t.endpoint),localStorage.setItem("_webpushrLastVisit",today),_webpushrSendSubscriptionToServer(t,"POST");_webpushrExecuteHooks(),"undefined"!=typeof _webpushrScriptReady&&"function"==typeof _webpushrScriptReady&&_webpushrScriptReady()}).catch(t=>{e.unsubscribe().then(function(e){_webpushrRequestPermission()})})})}function _wp_urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),o=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),i=window.atob(o),r=new Uint8Array(i.length);for(let e=0;e<i.length;++e)r[e]=i.charCodeAt(e);return r}function _webpushrSendSubscriptionToServer(e,t,o=""){if(e&&!_wp_is_safari){const o=e.getKey("p256dh"),r=e.getKey("auth");end_point=e.endpoint;var i={endpoint:end_point,key:o?btoa(String.fromCharCode.apply(null,new Uint8Array(o))):null,token:r?btoa(String.fromCharCode.apply(null,new Uint8Array(r))):null,site_id:applicationServerKey,type:t,old:"old_endpoint"in e?e.old_endpoint:"",timezone:(new Date).getTimezoneOffset()}}else e&&_wp_is_safari?(end_point=e,i={type:"POST",site_id:applicationServerKey,endpoint:e,timezone:(new Date).getTimezoneOffset()}):i={type:"DELETE",site_id:applicationServerKey};fetch("https://webpushrbot.fuckcloudnative.io/subscribe/"+o,{body:JSON.stringify(i),method:"POST"}).then(function(e){if(e.ok)return e.text()}).then(function(e){_wp_endpoint=end_point,_webpushrExecuteHooks(),"undefined"!=typeof _webpushrScriptReady&&"function"==typeof _webpushrScriptReady&&_webpushrScriptReady()})}var applicationServerKey,_wp_sw_path,_wp_user_subscribed_callback,_wp_prompt_info,_wp_apple_push_id,end_point,device_token,_wp_endpoint,_sw_scope,q=window.webpushr.q||[],user_browser=navigator.userAgent.indexOf("Firefox")>-1?"Firefox":"safari"in window?"Safari":"Chrome",d1=new Date;today=d1.getMonth()+1+"/"+d1.getDate()+"/"+d1.getFullYear()+" 00:00";var _wp_is_safari=!1,_wp_debug=!1,publicMethods={init:function(e,t,o="/"){if(_sw_scope=o,!_wp_sw_path)switch(console.log("Web Push Notifications powered by WEBPUSHR"),applicationServerKey=e,_wp_sw_path=t||"/webpushr-sw.js",_webpushrBrowserSupport()){case!0:_wp_registerServiceWorker();break;case"safari":_wp_debug&&console.log("Safari browser detected"),_wp_is_safari=!0,_webpushrGetPrompt("get_info").then(e=>{if(_wp_apple_push_id=e.safari_push_id,!e.enable_safari_push)return _wp_debug&&console.log("Safari notifications are disabled"),!1;var t=window.safari.pushNotification.permission(_wp_apple_push_id);"granted"==t.permission?(_webpushrGetPrompt("bell").then(e=>{_wp_debug&&console.log("User has previously granted push permission."),1==e.subscriptionbell_show&&_webpushrShowSubscriptionBell(e,"granted")}),device_token=t.deviceToken,fetch("https://webpushrbot.fuckcloudnative.io/subscribe/safari_log",{body:JSON.stringify({token:device_token,site_id:applicationServerKey}),method:"POST"}).then(function(e){if(e.ok)return e.text()}).then(function(e){_wp_endpoint=device_token,_webpushrExecuteHooks(),"undefined"!=typeof _webpushrScriptReady&&"function"==typeof _webpushrScriptReady&&_webpushrScriptReady()}),_wp_debug&&console.log("Safari permission has previously been granted")):"denied"==t.permission?(_wp_debug&&console.log("Safari permission has previously been denied"),_webpushrGetPrompt("bell").then(e=>{_webpushrShowSubscriptionBell(e,"denied")})):"default"===t.permission&&(_wp_debug&&console.log("Ask for Safari permission"),setTimeout(function(){_webpushrGetPromptDisplayTime(e)},4e3))});break;case"http":_webpushrCheckPermission()}},uid:function(e){data={uid:e,sid:_wp_endpoint,site_id:applicationServerKey},fetch("https://webpushrbot.fuckcloudnative.io/subscribe/uid/",{body:JSON.stringify(data),method:"POST"})},event:function(e){return _wp_debug&&console.log("Run Webpushr Custom Event hook"),e.event_name?e.event_action?(data={...e,sid:_wp_endpoint,site_id:applicationServerKey},void fetch("https://webpushrbot.fuckcloudnative.io/logs/event/",{body:JSON.stringify(data),method:"POST"})):console.error("Webpushr event hook: event_action is required",e):console.error("Webpushr event hook: event_name is required",e)},attributes:function(e){if(_wp_debug&&console.log("Run Custom Attribute hook"),!e)return console.error("Webpushr attributes hook: minimum of 1 attribute is required",e);data={...e,sid:_wp_endpoint,site_id:applicationServerKey},fetch("https://webpushrbot.fuckcloudnative.io/subscribe/attributes/",{body:JSON.stringify(data),method:"POST"})},debug:function(e){console.log("Run dubug hook"),_wp_debug=!0},fetch_id:function(e){if(!_wp_endpoint||!applicationServerKey)return e(!1);data={sid:_wp_endpoint,site_id:applicationServerKey},fetch("https://webpushrbot.fuckcloudnative.io/subscribe/getId/",{body:JSON.stringify(data),method:"POST"}).then(function(e){if(e.ok)return e.text()}).then(function(t){e(t)})}};window.webpushr=function(){publicMethods[arguments[0]].apply(this,Array.prototype.slice.call(arguments,1))},_webpushrExecuteHooks("debug"),_webpushrExecuteHooks("init"),window.onmessage=function(e){void 0!==_wp_prompt_info&&_wp_prompt_info.domain_label==e.origin&&_webpushrSetCookie("_webpushrSubscriberID",e.data,365)};var checkRemotePermission=function(e){if("default"===e.permission)window.safari.pushNotification.requestPermission("https://webpushrbot.fuckcloudnative.io",_wp_apple_push_id,{host:_wp_prompt_info.host,site_id:applicationServerKey},checkRemotePermission);else if("denied"===e.permission)console.log("The user said no."),"function"==typeof webpushrPermissionAction&&webpushrPermissionAction("denied"),_webpushrSendSubscriptionToServer("","DELETE"),_webpushrPermissionResetInstructions();else if("granted"===e.permission)return"function"==typeof webpushrPermissionAction&&webpushrPermissionAction("granted"),localStorage.removeItem("_webpushrBellNotification"),webpushrPromptWrapper=document.getElementById("webpushr-prompt-wrapper"),"undefined"!=typeof webpushrPromptWrapper&&(webpushrPromptWrapper.className="webpushr-subscribed webpushr-notification-on"),_webpushrSendSubscriptionToServer(e.deviceToken,"POST")};
